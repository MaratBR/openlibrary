package templates

import "github.com/MaratBR/openlibrary/internal/olhttp"
import "github.com/MaratBR/openlibrary/internal/app"
import "github.com/MaratBR/openlibrary/web/frontend"
import "github.com/MaratBR/openlibrary/internal/flash"
import "fmt"
import "github.com/MaratBR/openlibrary/internal/i18n"

templ flashes() {
    {{
        messages := flash.PullFlashes(ctx)
    }}

    if len(messages) > 0 {
        <div class="flash-container">
            for _, message := range messages {
                <div x-data class="flash">
                    @message
                    <div class="flash__closeContainer">
                        <button @click="$root.remove()" class="flash__close">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                </div>
            }
            <div id="client-flashes" class="contents" />
        </div>
    }
}

templ settings() {
    {{
        settings := getUIBookSettings(olhttp.GetRequest(ctx))
    }}
    @templ.Raw(fmt.Sprintf("<style>:root{--book-font-size:%dpx}</style>", settings.FontSize))
}

templ siteFooter() {
    {{ 
        version := app.AppVersion()
    }}

    <footer id="site-footer" class="ol-container p-10">
        <a href="https://github.com/MaratBR/openlibrary" class="text-muted-foreground hover:text-foreground" target="_blank">
            Powered by <span class="font-[500] font-title">OpenLibrary</span> <br />
            <span class="text-sm">v:{ version }</span>
        </a>
    </footer>
}

type htmlLayoutProps struct {
    Title string
    CSS []string
}

// htmlLayout is a basic layout of an HTML page with nothing in besides basic JS, CSS, common translations and UI settings
templ htmlLayout(params htmlLayoutProps) {
    {{
        modCss := "/_/assets/common.css"
        var css []string

        if len(params.CSS) > 0 {
            css = append(params.CSS, modCss)
        } else {
            css = []string{modCss}
        }
    }}

    @olhttp.Doc(ctx, olhttp.DocProps{
        Title: params.Title,
        Scripts: []string{ "/_/assets/common.js", "/_/assets/public.api.js", "/_/assets/alpinejs.js" },
        CSS: css,
        InstantClick: false,
        AppendToHead: templ.Join(
            frontend.InlineCSSAsset(ctx, "embed-assets", "fonts.css"),
        ),
    }) {
        {{
            l := i18n.GetLocalizer(ctx)
        }}
        @i18nExtractKeysByPrefix(l, "common")
        @settings()
        { children... }
  
    }
}

type standardPageLayoutProps struct {
    htmlLayoutProps
    DisableFooter bool
    DisableFlashes bool
    DisableHeader bool
}

templ standardPageLayout(props standardPageLayoutProps) {
    @htmlLayout(props.htmlLayoutProps) {
        if !props.DisableHeader {
            @siteHeader()
        }
        if !props.DisableFlashes {
            @flashes()
        }
        { children... }
        if !props.DisableFooter {
            @siteFooter()
        }
        <div id="toasts-root" class="flex flex-col left-1 bottom-1 fixed z-10 gap-1"></div>
    }
}


script toggleTheme() {
    let theme = getCookie('ui_theme');
    switch (theme) {
        case 'light':
            theme = 'dark';
            break;
        case 'dark':
            theme = '';
            break;
        case 'system':
        default:
            theme = 'light'
            break;
    }
    document.cookie = 'ui_theme=' + theme
    document.body.classList.toggle('dark', theme === 'dark');
}

templ themeSwitcher() {
    {{
        l := i18n.GetLocalizer(ctx)
    }}
    <button 
        onclick={toggleTheme()}
        class="btn btn--secondary  size-12" 
        aria-label={l.T("uiTheme.switchTheme")}>
        <i class="fa-solid fa-sun dark:!hidden"></i>
        <i class="fa-solid fa-moon !hidden dark:!inline-block"></i>
    </button>
}